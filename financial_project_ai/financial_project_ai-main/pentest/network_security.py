# pentest/network_security.py
import socket
import ssl
import logging
from typing import Dict, List

logger = logging.getLogger(__name__)


class NetworkSecurityTester:
    """Tests de sécurité réseau"""
    
    @staticmethod
    def test_tls_configuration(hostname: str = "127.0.0.1", port: int = 7860) -> Dict:
        """
        Tester la configuration TLS/SSL
        
        Args:
            hostname: Nom d'hôte
            port: Port
        
        Returns:
            Dict: Résultats
        """
        results = {
            'tls_enabled': False,
            'tls_version': None,
            'cipher_suite': None,
            'certificate_valid': False,
            'vulnerabilities': [],
            'recommendations': []
        }
        
        try:
            context = ssl.create_default_context()
            
            with socket.create_connection((hostname, port), timeout=5) as sock:
                with context.wrap_socket(sock, server_hostname=hostname) as ssock:
                    results['tls_enabled'] = True
                    results['tls_version'] = ssock.version()
                    results['cipher_suite'] = ssock.cipher()
                    
                    # Vérifier la version TLS
                    if ssock.version() in ['TLSv1', 'TLSv1.1']:
                        results['vulnerabilities'].append({
                            'severity': 'High',
                            'issue': f'Outdated TLS version: {ssock.version()}',
                            'recommendation': 'Use TLS 1.2 or higher'
                        })
        
        except ssl.SSLError:
            results['recommendations'].append({
                'severity': 'Critical',
                'issue': 'TLS/SSL not enabled',
                'recommendation': 'Enable HTTPS with valid certificate'
            })
        except Exception as e:
            logger.info(f"TLS test: {e}")
            results['recommendations'].append({
                'severity': 'High',
                'issue': 'Could not establish TLS connection',
                'recommendation': 'Ensure application is configured for HTTPS'
            })
        
        return results
    
    @staticmethod
    def test_http_headers() -> Dict:
        """
        Tester les headers de sécurité HTTP
        
        Returns:
            Dict: Résultats
        """
        results = {
            'missing_headers': [],
            'recommendations': []
        }
        
        required_headers = {
            'Strict-Transport-Security': 'Force HTTPS',
            'X-Content-Type-Options': 'Prevent MIME sniffing',
            'X-Frame-Options': 'Prevent clickjacking',
            'X-XSS-Protection': 'Enable XSS filter',
            'Content-Security-Policy': 'Prevent XSS and injection',
            'Referrer-Policy': 'Control referrer information'
        }
        
        # Ces headers devraient être présents
        for header, purpose in required_headers.items():
            results['missing_headers'].append({
                'header': header,
                'purpose': purpose,
                'severity': 'Medium'
            })
        
        results['recommendations'].append({
            'title': 'Implement Security Headers',
            'description': 'Add security headers to all HTTP responses',
            'priority': 'High'
        })
        
        return results
    
    @staticmethod
    def test_cors_configuration() -> Dict:
        """
        Tester la configuration CORS
        
        Returns:
            Dict: Résultats
        """
        results = {
            'issues': [],
            'recommendations': []
        }
        
        results['recommendations'].append({
            'title': 'Configure CORS Properly',
            'description': 'Restrict Access-Control-Allow-Origin to specific domains',
            'avoid': 'Access-Control-Allow-Origin: *',
            'priority': 'High'
        })
        
        return results