# pentest/ui_reports.py
import gradio as gr
import json
from pathlib import Path
from datetime import datetime
import subprocess
import threading
import os
import sys

# Ajouter le rÃ©pertoire parent au path
sys.path.insert(0, str(Path(__file__).parent.parent))


class PentestReportsUI:
    """Interface graphique pour gÃ©rer les rapports de pentest"""
    
    def __init__(self, reports_dir: str = "pentest_reports"):
        self.reports_dir = Path(reports_dir)
        self.reports_dir.mkdir(exist_ok=True)
        self.current_process = None
        self.pentest_running = False
    
    def get_all_reports(self):
        """RÃ©cupÃ©rer tous les rapports JSON"""
        json_files = sorted(
            self.reports_dir.glob("*.json"),
            key=lambda x: x.stat().st_mtime,
            reverse=True
        )
        
        reports = []
        for json_file in json_files:
            try:
                with open(json_file, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                
                # Extraire les informations clÃ©s
                metadata = data.get('metadata', {})
                summary = data.get('executive_summary', {})
                
                reports.append({
                    'filename': json_file.name,
                    'filepath': str(json_file),
                    'generated_at': metadata.get('generated_at', 'Unknown'),
                    'total_vulnerabilities': summary.get('total_vulnerabilities', 0),
                    'critical': summary.get('critical_count', 0),
                    'high': summary.get('high_count', 0),
                    'medium': summary.get('medium_count', 0),
                    'low': summary.get('low_count', 0),
                    'security_posture': summary.get('security_posture', 'Unknown'),
                    'size_kb': json_file.stat().st_size / 1024
                })
            except Exception as e:
                print(f"Error reading {json_file}: {e}")
        
        return reports
    
    def format_reports_table(self):
        """Formater les rapports en tableau HTML"""
        reports = self.get_all_reports()
        
        if not reports:
            return "<p>ğŸ“­ No reports found. Run a pentest to generate reports.</p>"
        
        html = """
        <style>
        .reports-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }
        .reports-table th {
            background-color: #2c3e50;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        .reports-table td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        .reports-table tr:hover {
            background-color: #f5f5f5;
        }
        .status-excellent { color: #27ae60; font-weight: bold; }
        .status-critical { color: #e74c3c; font-weight: bold; }
        .status-high { color: #e67e22; font-weight: bold; }
        .status-moderate { color: #f39c12; font-weight: bold; }
        .vuln-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .vuln-critical { background-color: #e74c3c; color: white; }
        .vuln-high { background-color: #e67e22; color: white; }
        .vuln-medium { background-color: #f39c12; color: white; }
        .vuln-low { background-color: #3498db; color: white; }
        </style>
        
        <table class="reports-table">
        <thead>
            <tr>
                <th>ğŸ“… Date</th>
                <th>ğŸ“Š Security Posture</th>
                <th>ğŸ” Vulnerabilities</th>
                <th>ğŸ“„ File</th>
                <th>ğŸ’¾ Size</th>
            </tr>
        </thead>
        <tbody>
        """
        
        for report in reports:
            # Formater la date
            try:
                dt = datetime.fromisoformat(report['generated_at'].replace('Z', '+00:00'))
                date_str = dt.strftime('%Y-%m-%d %H:%M:%S')
            except:
                date_str = report['generated_at']
            
            # Couleur de la posture
            posture = report['security_posture']
            if posture == "Excellent":
                posture_class = "status-excellent"
            elif posture == "Critical":
                posture_class = "status-critical"
            elif posture in ["High Risk", "High"]:
                posture_class = "status-high"
            else:
                posture_class = "status-moderate"
            
            # Badges de vulnÃ©rabilitÃ©s
            vulns_html = ""
            if report['critical'] > 0:
                vulns_html += f'<span class="vuln-badge vuln-critical">ğŸ”´ {report["critical"]} Critical</span> '
            if report['high'] > 0:
                vulns_html += f'<span class="vuln-badge vuln-high">ğŸŸ  {report["high"]} High</span> '
            if report['medium'] > 0:
                vulns_html += f'<span class="vuln-badge vuln-medium">ğŸŸ¡ {report["medium"]} Medium</span> '
            if report['low'] > 0:
                vulns_html += f'<span class="vuln-badge vuln-low">ğŸŸ¢ {report["low"]} Low</span> '
            
            if not vulns_html:
                vulns_html = '<span style="color: #27ae60;">âœ… No vulnerabilities</span>'
            
            html += f"""
            <tr>
                <td>{date_str}</td>
                <td><span class="{posture_class}">{posture}</span></td>
                <td>{vulns_html}</td>
                <td><code>{report['filename']}</code></td>
                <td>{report['size_kb']:.1f} KB</td>
            </tr>
            """
        
        html += """
        </tbody>
        </table>
        """
        
        return html
    
    def get_reports_dropdown_choices(self):
        """Obtenir la liste des rapports pour le dropdown"""
        reports = self.get_all_reports()
        
        if not reports:
            return []
        
        choices = []
        for report in reports:
            try:
                dt = datetime.fromisoformat(report['generated_at'].replace('Z', '+00:00'))
                date_str = dt.strftime('%Y-%m-%d %H:%M')
            except:
                date_str = "Unknown date"
            
            label = f"{date_str} - {report['security_posture']} ({report['total_vulnerabilities']} vulns)"
            choices.append((label, report['filename']))
        
        return choices
    
    def load_report_details(self, selected_file):
        """Charger les dÃ©tails d'un rapport"""
        if not selected_file:
            return "Select a report to view details."
        
        filepath = self.reports_dir / selected_file
        
        if not filepath.exists():
            return "Report file not found."
        
        try:
            with open(filepath, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            # Formater les dÃ©tails en JSON indentÃ©
            return json.dumps(data, indent=2, ensure_ascii=False)
        
        except Exception as e:
            return f"Error loading report: {str(e)}"
    
    def delete_report(self, selected_file):
        """Supprimer un rapport"""
        if not selected_file:
            return "âŒ No report selected", self.format_reports_table(), gr.update(choices=[])
        
        # Supprimer les fichiers JSON et MD correspondants
        json_path = self.reports_dir / selected_file
        md_path = self.reports_dir / selected_file.replace('.json', '.md')
        
        deleted_files = []
        
        try:
            if json_path.exists():
                json_path.unlink()
                deleted_files.append('JSON')
            
            if md_path.exists():
                md_path.unlink()
                deleted_files.append('MD')
            
            if deleted_files:
                message = f"âœ… Deleted report: {selected_file} ({', '.join(deleted_files)} files)"
            else:
                message = "âš ï¸ No files found to delete"
            
            # RafraÃ®chir la liste
            return message, self.format_reports_table(), gr.update(choices=self.get_reports_dropdown_choices(), value=None)
        
        except Exception as e:
            return f"âŒ Error deleting report: {str(e)}", self.format_reports_table(), gr.update(choices=self.get_reports_dropdown_choices())
    
    def delete_all_reports(self):
        """Supprimer tous les rapports"""
        try:
            json_files = list(self.reports_dir.glob("*.json"))
            md_files = list(self.reports_dir.glob("*.md"))
            
            total_deleted = 0
            
            for file in json_files + md_files:
                file.unlink()
                total_deleted += 1
            
            if total_deleted > 0:
                message = f"âœ… Deleted {total_deleted} files ({len(json_files)} reports)"
            else:
                message = "ğŸ“­ No reports to delete"
            
            return message, self.format_reports_table(), gr.update(choices=[], value=None)
        
        except Exception as e:
            return f"âŒ Error: {str(e)}", self.format_reports_table(), gr.update(choices=self.get_reports_dropdown_choices())
    
    def run_pentest(self, mode):
        """Lancer un pentest"""
        if self.pentest_running:
            return "âš ï¸ A pentest is already running. Please wait for it to complete."
        
        self.pentest_running = True
        
        try:
            # Lancer le pentest dans un sous-processus
            cmd = [sys.executable, "run_pentest.py", "--mode", mode]
            
            # Rediriger la sortie vers un fichier log
            log_file = self.reports_dir / f"pentest_log_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"
            
            with open(log_file, 'w') as f:
                f.write(f"Starting pentest in {mode} mode...\n")
                f.write(f"Command: {' '.join(cmd)}\n")
                f.write("=" * 80 + "\n\n")
                f.flush()
                
                # Lancer le processus
                process = subprocess.Popen(
                    cmd,
                    stdout=f,
                    stderr=subprocess.STDOUT,
                    text=True,
                    bufsize=1
                )
                
                self.current_process = process
                
                # Attendre la fin du processus
                return_code = process.wait()
                
                if return_code == 0:
                    result = f"âœ… Pentest completed successfully in {mode} mode!\n\nLog file: {log_file.name}"
                else:
                    result = f"âš ï¸ Pentest exited with code {return_code}. Check log: {log_file.name}"
        
        except Exception as e:
            result = f"âŒ Error running pentest: {str(e)}"
        
        finally:
            self.pentest_running = False
            self.current_process = None
        
        return result
    
    def run_pentest_async(self, mode):
        """Lancer un pentest de maniÃ¨re asynchrone"""
        if self.pentest_running:
            return "âš ï¸ A pentest is already running. Please wait for it to complete.", self.format_reports_table(), gr.update(choices=self.get_reports_dropdown_choices())
        
        # Lancer le pentest dans un thread sÃ©parÃ©
        def run_thread():
            result = self.run_pentest(mode)
            print(result)
        
        thread = threading.Thread(target=run_thread, daemon=True)
        thread.start()
        
        return f"ğŸš€ Starting pentest in {mode} mode... This may take several minutes.\n\nThe interface will update when the test is complete.", self.format_reports_table(), gr.update(choices=self.get_reports_dropdown_choices())
    
    def create_interface(self):
        """CrÃ©er l'interface Gradio"""
        with gr.Blocks(title="ğŸ”’ Pentest Reports Manager", theme=gr.themes.Soft()) as interface:
            gr.Markdown("""
            # ğŸ”’ Penetration Testing Dashboard & Report
            **Secure Financial Analysis Assistant - Security Dashboard**
            
            Manage your penetration test reports, view results, and launch new security assessments.
            """)
            
            with gr.Tabs():
                # Tab 1: Dashboard
                with gr.Tab("ğŸ“Š Dashboard"):
                    gr.Markdown("### ğŸ“ˆ Reports Overview")
                    
                    refresh_btn = gr.Button("ğŸ”„ Refresh", variant="secondary")
                    reports_table = gr.HTML(self.format_reports_table())
                    
                    refresh_btn.click(
                        fn=self.format_reports_table,
                        outputs=[reports_table]
                    )
                
                # Tab 2: View Report
                with gr.Tab("ğŸ” View Report"):
                    gr.Markdown("### ğŸ“„ Report Details")
                    
                    with gr.Row():
                        report_dropdown = gr.Dropdown(
                            label="Select Report",
                            choices=self.get_reports_dropdown_choices(),
                            interactive=True
                        )
                        refresh_dropdown_btn = gr.Button("ğŸ”„ Refresh List", size="sm")
                    
                    report_content = gr.Code(
                        label="Report Content (JSON)",
                        language="json",
                        lines=30
                    )
                    
                    report_dropdown.change(
                        fn=self.load_report_details,
                        inputs=[report_dropdown],
                        outputs=[report_content]
                    )
                    
                    refresh_dropdown_btn.click(
                        fn=lambda: gr.update(choices=self.get_reports_dropdown_choices()),
                        outputs=[report_dropdown]
                    )
                
                # Tab 3: Delete Reports
                with gr.Tab("ğŸ—‘ï¸ Delete Reports"):
                    gr.Markdown("### âš ï¸ Delete Reports")
                    gr.Markdown("**Warning:** Deletion is permanent and cannot be undone!")
                    
                    with gr.Row():
                        delete_dropdown = gr.Dropdown(
                            label="Select Report to Delete",
                            choices=self.get_reports_dropdown_choices(),
                            interactive=True
                        )
                        refresh_delete_btn = gr.Button("ğŸ”„ Refresh", size="sm")
                    
                    with gr.Row():
                        delete_btn = gr.Button("ğŸ—‘ï¸ Delete Selected Report", variant="stop")
                        delete_all_btn = gr.Button("âš ï¸ Delete ALL Reports", variant="stop")
                    
                    delete_status = gr.Textbox(label="Status", interactive=False)
                    delete_table = gr.HTML(self.format_reports_table())
                    
                    delete_btn.click(
                        fn=self.delete_report,
                        inputs=[delete_dropdown],
                        outputs=[delete_status, delete_table, delete_dropdown]
                    )
                    
                    delete_all_btn.click(
                        fn=self.delete_all_reports,
                        outputs=[delete_status, delete_table, delete_dropdown]
                    )
                    
                    refresh_delete_btn.click(
                        fn=lambda: gr.update(choices=self.get_reports_dropdown_choices()),
                        outputs=[delete_dropdown]
                    )
                
                # Tab 4: Run Pentest
                with gr.Tab("ğŸš€ Run Pentest"):
                    gr.Markdown("""
                    ### ğŸ”’ Launch Penetration Test
                    
                    **Important Notes:**
                    - Tests may take 5-60 minutes depending on the mode
                    - The interface may appear unresponsive during execution
                    - Results will be automatically saved to the reports directory
                    - Check the Dashboard tab after completion
                    """)
                    
                    with gr.Row():
                        mode_selector = gr.Radio(
                            label="Select Test Mode",
                            choices=[
                                ("Quick Scan (~5 min)", "quick"),
                                ("Full Scan (~15-30 min)", "full"),
                                ("Advanced Scan (~30-60 min)", "advanced")
                            ],
                            value="quick",
                            info="Quick: Basic tests | Full: All tests | Advanced: Full + sophisticated attacks"
                        )
                    
                    run_pentest_btn = gr.Button("ğŸš€ Launch Pentest", variant="primary", size="lg")
                    
                    pentest_status = gr.Textbox(
                        label="Status",
                        lines=5,
                        interactive=False
                    )
                    
                    pentest_table = gr.HTML(self.format_reports_table())
                    pentest_dropdown = gr.Dropdown(
                        label="Available Reports",
                        choices=self.get_reports_dropdown_choices()
                    )
                    
                    run_pentest_btn.click(
                        fn=self.run_pentest_async,
                        inputs=[mode_selector],
                        outputs=[pentest_status, pentest_table, pentest_dropdown]
                    )
                
                # Tab 5: Statistics
                with gr.Tab("ğŸ“Š Statistics"):
                    gr.Markdown("### ğŸ“ˆ Security Metrics Overview")
                    
                    stats_refresh = gr.Button("ğŸ”„ Refresh Statistics")
                    stats_display = gr.HTML(self.generate_statistics_html())
                    
                    stats_refresh.click(
                        fn=self.generate_statistics_html,
                        outputs=[stats_display]
                    )
            
            gr.Markdown("""
            ---
            **Penetration Testing Suite v1.0** | Framework: MITRE ATT&CK + OWASP Top 10 + LLM Security
            """)
        
        return interface
    
    def generate_statistics_html(self):
        """GÃ©nÃ©rer des statistiques HTML"""
        reports = self.get_all_reports()
        
        if not reports:
            return "<p>ğŸ“­ No reports available for statistics.</p>"
        
        # Calculer les statistiques
        total_reports = len(reports)
        total_vulns = sum(r['total_vulnerabilities'] for r in reports)
        total_critical = sum(r['critical'] for r in reports)
        total_high = sum(r['high'] for r in reports)
        total_medium = sum(r['medium'] for r in reports)
        total_low = sum(r['low'] for r in reports)
        
        # Compter les postures de sÃ©curitÃ©
        posture_counts = {}
        for r in reports:
            posture = r['security_posture']
            posture_counts[posture] = posture_counts.get(posture, 0) + 1
        
        html = f"""
        <div style="padding: 20px;">
            <h3>ğŸ“Š Overall Statistics</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
                <div style="background: #3498db; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <h2 style="margin: 0;">{total_reports}</h2>
                    <p style="margin: 5px 0 0 0;">Total Reports</p>
                </div>
                <div style="background: #e74c3c; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <h2 style="margin: 0;">{total_critical}</h2>
                    <p style="margin: 5px 0 0 0;">Critical Vulnerabilities</p>
                </div>
                <div style="background: #e67e22; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <h2 style="margin: 0;">{total_high}</h2>
                    <p style="margin: 5px 0 0 0;">High Vulnerabilities</p>
                </div>
                <div style="background: #f39c12; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <h2 style="margin: 0;">{total_medium}</h2>
                    <p style="margin: 5px 0 0 0;">Medium Vulnerabilities</p>
                </div>
            </div>
            
            <h3>ğŸ¯ Security Posture Distribution</h3>
            <ul style="font-size: 16px;">
        """
        
        for posture, count in posture_counts.items():
            percentage = (count / total_reports) * 100
            html += f"<li><strong>{posture}:</strong> {count} reports ({percentage:.1f}%)</li>"
        
        html += """
            </ul>
        </div>
        """
        
        return html


def main():
    """Point d'entrÃ©e principal"""
    ui = PentestReportsUI()
    interface = ui.create_interface()
    
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                              â•‘
â•‘     ğŸ”’ PENTEST REPORTS MANAGER                              â•‘
â•‘     Security Dashboard & Test Orchestration                 â•‘
â•‘                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)
    
    interface.launch(
        server_name="127.0.0.1",
        server_port=7861,
        share=False
    )


if __name__ == "__main__":
    main()